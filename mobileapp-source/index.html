<html> 
<head> 
	<title>CommunityFinder.net</title> 
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	<link rel="stylesheet" type="text/css" href="css/index.css" />
	
	<!-- jquery mobile - 1 -->
	<link rel="stylesheet"  href="css/jqm_themes/default/jquery.mobile-1.2.0.css" />
	<script src="js/jquery-1.8.3.min.js"></script>
	<script src="js/jquery.mobile-1.2.0.min.js"></script>
	<!-- jquery mobile - 0 -->

	<!-- jquery maps - 1 -->
	<script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<script src="js/jquery.ui.map.min.js"></script>
	<script src="js/jquery.ui.map.extensions.js"></script>
	<script src="js/jquery.ui.map.services.min.js"></script>
	<!-- jquery maps - 0 -->
	
	<!-- phonegap - 1 -->
	<script type="text/javascript" src="cordova-2.2.0.js"></script>
	<script type="text/javascript" src="js/index.js"></script>
	<script type="text/javascript">
		app.initialize();
	</script>
	<!-- phonegap - 0 -->
<script>
	/////////////////////////////////////////////
	// to add
	/////////////////////////////////////////////
	//	   	soon
	//   		closing infoWindow before refresh markers (currently stays open if refresh search)
	//
	//		later
	//   		dialog box when clicking marker 
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-geocoding.html
	//   		pagination of items when clicking a marker: 
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-extend-with-pagination.html
	//			micro data page view  
	//		  		http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-microdata.html
	/////////////////////////////////////////////
	// to add
	/////////////////////////////////////////////

	var DEFAULT_LOCATION = new google.maps.LatLng(-37.820724999999996,145.03867549999998);
	var DEFAULT_ZOOM = 15;
		
		// draw map centred on location. retrieve results
		function mapLocation(location){
			$('#map_canvas').gmap('option', 'center', location);
			$('#map_canvas').gmap('option', 'zoom', DEFAULT_ZOOM);
			loadMarkers(location);
		}
		
		// gecode location and do a search
		// https://developers.google.com/maps/documentation/geocoding/
		function findLocationByName(address){
			var geocoder = new google.maps.Geocoder(); // v3
			geocoder.geocode( { 'address': address}, function(results, status) { // v3
				switch (status) {
					case google.maps.GeocoderStatus.OK:
						var location = results[0];
						mapLocation(location.geometry.location);
						return;
					case google.maps.GeocoderStatus.ZERO_RESULTS:
						alert("No results found");
						return;
					case google.maps.GeocoderStatus.OVER_QUERY_LIMIT:
						alert("Too many API calls...");
						return; 
					case google.maps.GeocoderStatus.REQUEST_DENIED:
						alert("Request Denied. sensor not set?");
						return;
					case google.maps.GeocoderStatus.INVALID_REQUEST:
						alert("Invalid request. Missing search location?");
						return;
					default:
						alert("Unknown error");
						return;
				}
			});
		}
		
		// does the search based on a location
		// calls backend API
		function loadMarkers(location){
			var map = $('#map_canvas').gmap('get', 'map'); 
			var Bounds = map.getBounds();
			var NorthEast = Bounds.getNorthEast();
			var SouthWest = Bounds.getSouthWest();
			var north_lat = NorthEast.lat();
			var east_lng = NorthEast.lng();
			var south_lat = SouthWest.lat();
			var west_lng = SouthWest.lng();	
			
			var filter_text = $("#txtSearch").val();
			var filter_subtype = "";
			var username = "";
			var lid = "";
			$('#map_canvas').gmap('clear', 'markers');
			$("#listItems").html("Loading items...")

			/*
				JSON call
				/communityfinder/webapp-source/data/get_markers.php?
					format=json&
					north_lat=-35.59478566548724&
					east_lng=149.1119384765625&
					south_lat=-38.47079371120379&
					west_lng=142.0806884765625&
					filter_text=farm&
					filter_subtype=&
					username=&
					listing_id=		
			//*/		
			
			$.getJSON('http://communityfinder.net/data/get_markers.php', {format:"json",north_lat:north_lat, east_lng:east_lng, south_lat:south_lat, west_lng:west_lng, filter_text: filter_text, filter_subtype: filter_subtype, username:username, listing_id: lid}, function(data) {
				$("#listItems").html("");
				
				/*
				http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-data-attribute.html
				format of LI
							<li data-gmapping='{"id":"m_1","latlng":{"lat":27.6648274,"lng":-81.51575350000002},"tags":"drupal"}'>
								<p class="info-box">Florida DrupalCamp - Feb 11 2012</p>
							</li>
				*/				
				if(!data.markers || data.markers.length == 0){
					$("#listItems").append(jQuery("<li>").append(jQuery("<p>").val("No results found").addClass("info-box")));
				}
				else{
					for(var i = 0; i < data.markers.length; i++){
						var m = data.markers[i];
						var m_data = {id: m.lid, latlng: {lat: m.lat, lng: m.lng} };
						$("#listItems").append(jQuery("<li>").attr("data-gmapping", JSON.stringify(m_data)).append(jQuery("<p>").html('<a class="listing_link" data-parm="' + m.lid + '" href="#listing_detail" data-transition="fade">' + m.name + '</a>').addClass("info-box")));
					}
				}
				loadMarkersFromList();
			});
		}

		// load markers based on current centre (used when center is not known. e.g. on dragend)
		function loadMarkersRefresh(){
			loadMarkers($('#map_canvas').gmap('option', 'center'));
		}
		
		// reads meta-data in LI node and display on map
		// http://jquery-ui-map.googlecode.com/svn/trunk/demos/jquery-google-maps-data-attribute.html
		function loadMarkersFromList(){
			$("[data-gmapping]").each(function(i,el) {
				var data = $(el).data('gmapping');
				$('#map_canvas').gmap('addMarker', {
						'id': data.id, 
						'tags':data.tags, 
						'position': new google.maps.LatLng(data.latlng.lat, data.latlng.lng), 
						'bounds':false  // do not snap map to fit all points
					}, function(map,marker) {
					$(el).click(function() {
						$(marker).triggerEvent('click');
					});
				}).click(function() {
					$('#map_canvas').gmap('openInfoWindow', { 'content': $(el).find('.info-box').html() }, this);
				});
			});		
		}
		
		$(document).ready(function () {

			// item details page - 1
			$("a.listing_link").live('click',function(e) {
				$.getJSON('http://communityfinder.net/data/get_markers.php?format=json&listing_id=' + $(this).attr("data-parm"), function(data) {
					$('#name').html(data.markers[0].name);
					$('#description').html(data.markers[0].desc);
					$('#user').html(data.markers[0].username);
					$('#type').html(data.markers[0].type);
					$('#address').html(data.markers[0].address);
					$('#phone').html(data.markers[0].phone);
					$('#www').html(data.markers[0].www);
				});
			});
			// item details page - 0
			
			///////////////////////////////////////////////////////////////////////////
			// main map page - 1
			///////////////////////////////////////////////////////////////////////////

			// search - 1
			$("#btnLocation").click(function(e){
				e.preventDefault();
				findLocationByName($("#txtLocation").val());
			});
			$("#btnMyLocation").click(function(e){
				$('#map_canvas').gmap('getCurrentPosition', function(position, status) {
					var position;
					if ( status === 'OK' ) {
						e.preventDefault();
						 position = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
					}
					else{
						position = DEFAULT_LOCATION;;
					}
					mapLocation(position);
				});
			});
			// search - 0
			
			// filter - 1
			$("#btnSearch").click(function(e){
				var map = $('#map_canvas').gmap('get', 'center'); 
				loadMarkers($('#map_canvas').gmap('option', 'center'));
			});
			// filter - 0

			
			// init map - 1
			$('#map_canvas').gmap({'center': DEFAULT_LOCATION, 'zoom': DEFAULT_ZOOM}).bind('init', function(evt, map) {
				loadMarkersRefresh();
				
				// drag map. load search after 1 second after drag ends
				var drag_timer;
				$(map).dragend(function(){
					clearTimeout(drag_timer);
					drag_timer = setTimeout("loadMarkersRefresh()", 1000);
				});
				$(map).drag(function(){
					clearTimeout(drag_timer);
				});
			});
			// init map - 0
			///////////////////////////////////////////////////////////////////////////
			// main map page - 0
			///////////////////////////////////////////////////////////////////////////
		});


</script>
</head> 
<body> 
	<div data-role="page" id="map">
		<div data-role="header">
			<h1>CommunityFinder.net</h1>
		</div><!-- /header -->

		<div data-role="content">	
			Step 1: Specify location <input id="txtLocation" type="text" value="brunswick west"><input id="btnLocation" type="button" value="View Location">
			<input id="btnMyLocation" type="button" value="Near Me">

			<div id="map_canvas" style="height: 300px; width: 100%"></div>
			Step 2: Add filter <input id="txtSearch" type="text"><input id="btnSearch" type="button" value="Search Location">

			<ul id='listItems'>
			</ul>
		</div><!-- /content -->
	</div><!-- /page -->

	<div data-role="page" id="listing_detail">
		<div data-role="header">
			<h1 id="name">My Title</h1>
		</div><!-- /header -->
		<div data-role="content">
			<div class="ui-grid-a">
				<div class="ui-block-a">
					<h5 id="user">
						Added by
					</h5>
				</div>
				<div class="ui-block-b" id="type">
					<h3 id="type">
						Category
					</h3>
				</div>
			</div>
			<h5 id="address">
				Street, Suburb, City, Postcode
			</h5>
			<div id="phone">
				<a href="tel:0400200700" target="_blank" data-transition="fade">
					Phone
				</a>
			</div>
			<div id="www">
				<a href="google.com" target="_blank" data-transition="fade">
					Web Site
				</a>
			</div>
			<span id="description">
				Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Donec sed odio dui.
			</span>
			<div>
				<a href="#" target="_blank" data-transition="fade">
					Share link
				</a>
			</div>
		</div>
	</div>
        <!-- /page listing_detail -->
</body>
</html>