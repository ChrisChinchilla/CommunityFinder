<html> 
<head> 
	<title>My Page</title> 
	
	        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
	
	
	<!-- jquery mobile - 1 -->
	<link rel="stylesheet"  href="css/jqm_themes/default/jquery.mobile-1.2.0.css" />
	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.2.0.min.js"></script>
	<!-- jquery mobile - 0 -->


	<!-- jquery maps - 1 -->
	<script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<script src="js/jquery.ui.map.min.js"></script>
	<script src="js/jquery.ui.map.extensions.js"></script>
	<script src="js/jquery.ui.map.services.js"></script>
	
	        <script type="text/javascript" src="cordova-2.2.0.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
	
	<!-- jquery maps - 0 -->
	
	
<script>
// dialog box http://localhost/jquery-ui-map/demos/jquery-google-maps-geocoding.html
	// pages:
	//		map of listings
	//			map of listings based on list http://localhost/jquery-ui-map/demos/jquery-google-maps-data-attribute.html
	//			map of listings with item selected (hover / snippet)
	// 				pagination http://localhost/jquery-ui-map/demos/jquery-google-maps-extend-with-pagination.html
	//		page view  http://localhost/jquery-ui-map/demos/jquery-google-maps-microdata.html
	
	// Move this into a utility function
		/*
				http://localhost/communityfinder/webapp-source/data/get_markers.php?
					format=json&
					north_lat=-35.59478566548724&
					east_lng=149.1119384765625&
					south_lat=-38.47079371120379&
					west_lng=142.0806884765625&
					filter_text=farm&
					filter_subtype=&
					username=&
					listing_id=		
		*/
		
		
		// draw map centred on location. retrieve results
		function mapLocation(location){
			$('#map_canvas').gmap('option', 'center', location);
			$('#map_canvas').gmap('option', 'zoom', 15);
			loadMarkers(location);
		}
		function findLocationByName(address){
			// https://developers.google.com/maps/documentation/geocoding/
			var geocoder = new google.maps.Geocoder(); // v3
			geocoder.geocode( { 'address': address}, function(results, status) { // v3
				switch (status) {
					case google.maps.GeocoderStatus.OK:
						var location = results[0];
						console.log(location.formatted_address);
						mapLocation(location.geometry.location);
						return;
					case google.maps.GeocoderStatus.ZERO_RESULTS:
						alert("No results found");
						return;
					case google.maps.GeocoderStatus.OVER_QUERY_LIMIT:
						alert("Too many API calls...");
						return; 
					case google.maps.GeocoderStatus.REQUEST_DENIED:
						alert("Request Denied. sensor not set?");
						return;
					case google.maps.GeocoderStatus.INVALID_REQUEST:
						alert("Invalid request. Missing search location?");
						return;
					default:
						alert("Unknown error");
						return;
				}
			});
		}
		function loadMarkers(location){
			var map = $('#map_canvas').gmap('get', 'map'); 
			var Bounds = map.getBounds();
			var NorthEast = Bounds.getNorthEast();
			var SouthWest = Bounds.getSouthWest();
			var north_lat = NorthEast.lat();
			var east_lng = NorthEast.lng();
			var south_lat = SouthWest.lat();
			var west_lng = SouthWest.lng();	
			
			var filter_text = $("#txtSearch").val();
			var filter_subtype = "";
			var username = "";
			var lid = "";
			$('#map_canvas').gmap('clear', 'markers');

			$.getJSON('http://communityfinder.net/data/get_markers.php', {format:"json",north_lat:north_lat, east_lng:east_lng, south_lat:south_lat, west_lng:west_lng, filter_text: filter_text, filter_subtype: filter_subtype, username:username, listing_id: lid}, function(data) {
				$("#listItems").html("");
				if(!data.markers || data.markers.length == 0){
					$("#listItems").append(jQuery("<li>").append(jQuery("<p>").val("No results found").addClass("info-box")));
				}
				else{
					for(var i = 0; i < data.markers.length; i++){
						var m = data.markers[i];
						var m_data = {id: m.lid, latlng: {lat: m.lat, lng: m.lng} };
						$("#listItems").append(jQuery("<li>").attr("data-gmapping", JSON.stringify(m_data)).append(jQuery("<p>").html('<a class="listing_link" data-parm="' + m.lid + '" href="#listing_detail" data-transition="fade">' + m.name + '</a>').addClass("info-box")));
					}
				}
				
				
				loadMarksFromHTMLList();
			});
	/*
						<li data-gmapping='{"id":"m_1","latlng":{"lat":27.6648274,"lng":-81.51575350000002},"tags":"drupal"}'>
							<p class="info-box">Florida DrupalCamp - Feb 11 2012</p>
						</li>
	
				http://localhost/communityfinder/webapp-source/data/get_markers.php?
					format=json&
					north_lat=-35.59478566548724&
					east_lng=149.1119384765625&
					south_lat=-38.47079371120379&
					west_lng=142.0806884765625&
					filter_text=farm&
					filter_subtype=&
					username=&
					listing_id=		
	//*/		
		}
			
		function loadMarksRefresh(){
			loadMarkers($('#map_canvas').gmap('option', 'center'));
		}
		
		function loadMarkersFromJSON(){
			$.getJSON( 'demo.json', function(data) { 
				$.each( data.markers, function(i, marker) {
					$('#map_canvas').gmap('addMarker', { 
						'position': new google.maps.LatLng(marker.latitude, marker.longitude), 
						'bounds': true 
					}).click(function() {
						$('#map_canvas').gmap('openInfoWindow', { 'content': marker.content }, this);
					});
				});
			});		
		}
		
		function loadMarksFromHTMLList(){
			$("[data-gmapping]").each(function(i,el) {
				var data = $(el).data('gmapping');
				$('#map_canvas').gmap('addMarker', {
						'id': data.id, 
						'tags':data.tags, 
						'position': new google.maps.LatLng(data.latlng.lat, data.latlng.lng), 
						'bounds':false  // do not snap map to fit all points
					}, function(map,marker) {
					$(el).click(function() {
						$(marker).triggerEvent('click');
					});
				}).click(function() {
					$('#map_canvas').gmap('openInfoWindow', { 'content': $(el).find('.info-box').html() }, this);
				});
			});		
		}
		
		$(document).ready(function () {
		
			$("a.listing_link").live('click',function(e) {
				console.log( $(this).attr("data-parm"));
				$.getJSON('http://communityfinder.net/data/get_markers.php?format=json&listing_id=' + $(this).attr("data-parm"), function(data) {
					console.log(data.markers[0]);
	
					$('#name').html(data.markers[0].name);
					$('#description').html(data.markers[0].desc);
					$('#user').html(data.markers[0].username);
					$('#type').html(data.markers[0].type);
					$('#address').html(data.markers[0].address);
					$('#phone').html(data.markers[0].phone);
					$('#www').html(data.markers[0].www);

				});
			});
			
			$("#btnTest").click(function(e){
				//findLocationByName('brunswick');
				//loadMarksFromHTMLList();
				//loadMarkersFromJSON();
			});
			
			// specify location - 1
			$("#btnLocation").click(function(e){
				e.preventDefault();
				findLocationByName($("#txtLocation").val());
			});
			$("#btnMyLocation").click(function(e){
				$('#map_canvas').gmap('getCurrentPosition', function(position, status) {
					var position;
					if ( status === 'OK' ) {
						e.preventDefault();
						 position = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
					}
					else{
						position = new google.maps.LatLng(-37.820724999999996,145.03867549999998);
					}
					mapLocation(position);
				});
			});
			// specify location - 0
			
			$("#btnSearch").click(function(e){
				var map = $('#map_canvas').gmap('get', 'center'); 
				loadMarkers($('#map_canvas').gmap('option', 'center'));
			});
			
			$('#map_canvas').gmap().bind('init', function(evt, map) {
				
				
				// drag map. load search after 1 second after drag ends
				var drag_timer;
				$(map).dragend(function(){
					clearTimeout(drag_timer);
					drag_timer = setTimeout("loadMarksRefresh()", 1000);
				});
				$(map).drag(function(){
					clearTimeout(drag_timer);
				});
				// 
				
				
				$('#map_canvas').gmap('getCurrentPosition', function(position, status) {
					var clientPosition;
					if ( status === 'OK' ) {
						 clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
					}
					else{
						clientPosition = new google.maps.LatLng(-37.820724999999996,145.03867549999998);
					}
				
					
					/* add shape
					$('#map_canvas').gmap('addShape', 'Circle', { 
						'strokeWeight': 0, 
						'fillColor': "#008595", 
						'fillOpacity': 0.25, 
						'center': clientPosition, 
						'radius': 15, 
						'clickable': false 
					});
					//*/
				});   
			});


			/* standard Google Maps - ignore for now
			var mapOptions = {
				zoom: 14,
				center: new google.maps.LatLng(0,0),
				mapTypeId: google.maps.MapTypeId.ROADMAP
			}; // v3
			map = new google.maps.Map(document.getElementById('map_div'), mapOptions); // v3
			
			//bind map clicks to map click controller	
			//GEvent.bind(map, "click", this, this.onMapClick); // v2
			google.maps.event.addListener(map, 'click', function(event){ application.onMapClick(null, event.latLng); }); // v3
			//*/
		});


</script>
</head> 
<body> 

<div data-role="page" id="map">

	<div data-role="header">
		<h1>My Title</h1>
	</div><!-- /header -->

	<div data-role="content">	
		Step 1: Specify location <input id="txtLocation" type="text" value="brunswick"><input id="btnLocation" type="button" value="View Location">
		<input id="btnMyLocation" type="button" value="Near Me">

		<div id="map_canvas" style="height: 300px; width: 100%"></div>
		Step 2: Add filter <input id="txtSearch" type="text"><input id="btnSearch" type="button" value="Search Location">

					<ul id='listItems'>
						<li data-gmapping='{"id":"m_1","latlng":{"lat":27.6648274,"lng":-81.51575350000002},"tags":"drupal"}'>
							<p class="info-box">Florida DrupalCamp - Feb 11 2012</p>
						</li>
						<li data-gmapping='{"id":"m_2","latlng":{"lat":1.352083,"lng":103.81983600000001},"tags":"drupal"}'>
							<p class="info-box">DrupalCamp Singapore - Mar 03 2012</p>					
						</li>
						<li data-gmapping='{"id":"m_3","latlng":{"lat":39.7391536,"lng":-104.9847034},"tags":"drupal"}'>
							<p class="info-box">DrupalCon 2012 Denver - Mar 20 2012</p>				
						</li>
						<li data-gmapping='{"id":"m_4","latlng":{"lat":36.1658899,"lng":-86.7844432},"tags":"drupal"}'>
							<p class="info-box">DrupalCamp Nashville - Apr 28 2012</p>				
						</li>
						<li data-gmapping='{"id":"m_5","latlng":{"lat":55.6760968,"lng":12.568337100000008},"tags":"drupal"}'>
							<p class="info-box">DrupalCamp Copenhagen 5.0 - May 11 2012</p>				
						</li>
					</ul>

		<input id="btnTest" type="button" value="test">
	</div><!-- /content -->

</div><!-- /page -->


<div data-role="page" id="listing_detail">
        	<div data-role="header">
		<h1 id="name">My Title</h1>
	</div><!-- /header -->
            <div data-role="content">

                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <h5 id="user">
                            Added by
                        </h5>
                    </div>
                    <div class="ui-block-b" id="type">
                        <h3 id="type">
                            Category
                        </h3>
                    </div>
                </div>
                <h5 id="address">
                    Street, Suburb, City, Postcode
                </h5>
                <div id="phone">
                    <a href="tel:0400200700" target="_blank" data-transition="fade">
                        Phone
                    </a>
                </div>
                <div id="www">
                    <a href="google.com" target="_blank" data-transition="fade">
                        Web Site
                    </a>
                </div>
                <span id="description">
                    Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Donec sed odio dui.
                </span>
                <div>
                    <a href="#" target="_blank" data-transition="fade">
                        Share link
                    </a>
                </div>
            </div>
        </div>
        <!-- /page listing_detail -->
</body>
</html>